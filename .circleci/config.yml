version: 2.1

jobs:
  build-android:
    docker:
      - image: cimg/android:2023.09
    steps:
      - checkout
      
      - run:
          name: Check Node.js and npm
          command: |
            echo "Node version:"
            node --version || echo "Node not found"
            echo "npm version:"
            npm --version || echo "npm not found"
            echo "Java version:"
            java --version
            
      - run:
          name: Install Node.js if missing
          command: |
            if ! command -v npm &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            npm --version
            
      - restore_cache:
          keys:
            - v1-deps-{{ checksum "package.json" }}
            
      - run:
          name: Install dependencies
          command: npm ci
          
      - save_cache:
          paths:
            - node_modules
          key: v1-deps-{{ checksum "package.json" }}
          
      - run:
          name: Build Android APK
          command: |
            cd android
            chmod +x gradlew
            ./gradlew assembleDebug --stacktrace
            
      - store_artifacts:
          path: android/app/build/outputs/apk/debug/
          destination: android-apk
          
      - run:
          name: Build Success
          command: |
            echo "âœ… BUILD COMPLETE!"
            echo "APK: android/app/build/outputs/apk/debug/app-debug.apk"
            ls -lh android/app/build/outputs/apk/debug/app-debug.apk

workflows:
  version: 2
  android-build:
    jobs:
      - build-android