version: 2.1

jobs:
  build-android:
    docker:
      - image: cimg/android:2024.01.1-node
    steps:
      - checkout
      
      - run:
          name: Install build tools (Ninja, CMake)
          command: |
            sudo apt-get update
            sudo apt-get install -y ninja-build cmake
            
      - run:
          name: Verify tools
          command: |
            echo "Ninja version:"
            ninja --version || echo "Ninja not found"
            echo "CMake version:"
            cmake --version || echo "CMake not found"
            
      - restore_cache:
          keys:
            - v1-deps-{{ checksum "package.json" }}
            
      - run:
          name: Install dependencies
          command: npm ci
          
      - save_cache:
          paths:
            - node_modules
          key: v1-deps-{{ checksum "package.json" }}
          
      - run:
          name: Build Android APK (Skip NDK)
          command: |
            cd android
            chmod +x gradlew
            # Disable NDK/new architecture for now
            ./gradlew assembleDebug \
              -PreactNativeArchitectures=x86,x86_64 \
              -PnewArchEnabled=false
              
      - store_artifacts:
          path: android/app/build/outputs/apk/debug/
          destination: android-apk
          
      - run:
          name: Success Message
          command: |
            echo "âœ… BUILD SUCCESSFUL!"
            if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
              echo "ðŸ“± APK Size:"
              ls -lh android/app/build/outputs/apk/debug/app-debug.apk
            fi

workflows:
  version: 2
  android-build:
    jobs:
      - build-android